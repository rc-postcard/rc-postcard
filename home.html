<!DOCTYPE html>
<html lang="en">

<head>
    <title>rc-postcard</title>
    <script type="text/javascript">
        window.onload = function () {
            const addressButton = document.getElementById('addressButton');
            const addressDiv = document.getElementById('addressDiv')
            const submitPhotoButton = document.getElementById('submitPhoto');
            const submitPostcardButton = document.getElementById('submitPostcard')
            const recipientSelector = document.getElementById('recipientSelector')

            fetch("/addresses").then(response => 
                response.json()
            ).then(data => {
                document.getElementById("name").innerText = data["name"]
                document.getElementById("address1").innerText = data["address_line1"]
                document.getElementById("address2").innerText = data["address_line2"]
                document.getElementById("city").innerText = data["address_city"]
                document.getElementById("state").innerText = data["address_state"]
                document.getElementById("zip").innerText = data["address_zip"]
            })

            fetch("/contacts").then(response => 
                response.json()
            ).then(data => {
                contacts = data["contacts"]
                contacts.forEach(contact => {
                    var opt = document.createElement('option')
                    opt.value = contact["recurseId"]
                    opt.innerHTML = contact["name"] + " (" + contact["email"] + ")"
                    recipientSelector.appendChild(opt)
                });
            })

            addressButton.addEventListener('click', function () {
                if (addressDiv.style.display === "none") {
                    addressButton.innerText = "Hide my address üëª"
                    addressDiv.style.display = "block";
                } else {
                    addressButton.innerText = "Show my address :)"
                    addressDiv.style.display = "none";
                }
            })

            submitPhotoButton.addEventListener('click', function () {
                console.log("clicked")
                let photo = document.getElementById("postcardFileInput").files[0]
                if (!photo) {
                    console.log("no photo")
                    return;
                }
                let formData = new FormData()
                formData.append("front-postcard-file", photo)
                fetch("/postcards?isPreview=true&toRecurseId=0", { method: "POST", body: formData }).then(response =>
                    response.json()
                ).then(data => {
                    pdfPreviewLink = document.getElementById("pdfPreviewLink")
                    pdfPreviewLink.innerText = data['url']
                    pdfPreviewLink.href = data['url']
                })
            });

            submitPostcardButton.addEventListener('click', function () {
                let photo = document.getElementById("postcardFileInput").files[0]
                let recipientId = recipientSelector.value
                if (!photo) {
                    console.log("no photo")
                    return
                }
                if (!recipientId) {
                    console.log("no recipient")
                    return
                }

                console.log("sending postcard to " + recipientId)
                let formData = new FormData()
                formData.append("front-postcard-file", photo)
                fetch("/postcards?isPreview=false&toRecurseId=" + recipientId, {method: "POST", body: formData }).then(response => 
                    response.json()
                ).then(data => {
                    console.log(data)
                })
            })
        }
    </script>
    <style>
        * {
            box-sizing: border-box;
            color: #333333;
            font-family: "Comic Sans MS", "Comic Sans", cursive;
        }

        input {
            display: block;
            font-size: 1.05rem;
            width: 100%;
            padding: 10px;
            border-radius: .25rem;
            border: solid 1px #8c8c8c;
            margin: 0;
        }

        label {
            display: block;
            font-size: 1.1rem;
            margin: 20px 0 5px 0;
        }

        button {
            background-color: #0594d8;
            color: #ffffff;
            border-color: #ffffff;
            font-size: 1.1rem;
            margin-top: 10px;
            width: 100px;
        }
    </style>
</head>

<body>
    <button id="addressButton">Show my address :)</button>
    <div style="display: none;" id="addressDiv">
        <div id="name"></div>
        <div id="address1"></div>
        <div id="address2"></div>
        <div id="city"></div>
        <div id="state"></div>
        <div id="zip"></div>
    </div>
    <input type="file" id="postcardFileInput" />
    <button id="submitPhoto">Preview</button>
    <div>
        <label id="pdfPreviewLabel">PDF Preview (try refreshing a few times)</label>
        <a target="_blank" id="pdfPreviewLink" href=""></a>
    </div>
    <div>
        <label>Select who you'd like to send your postcard to. See someone in RC who's not on the list? Tell them to
            sign up at LINK</label>
        <select id="recipientSelector" name="Recipient" id="receipients">
        </select>
        <br><br>
    </div>
    <button id="submitPostcard">Looks good, submit!</button>

    <div>Made with ‚ù§Ô∏è at the Recurse Center.</div>
</body>

</html>