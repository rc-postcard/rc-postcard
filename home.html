<!DOCTYPE html>
<html lang="en">

<head>
    <title>rc-postcard</title>
    <script type="text/javascript">
        window.onload = function () {
            const addressButton = document.getElementById('addressButton');
            const deleteAddressButton = document.getElementById('deleteAddressButton');
            const addressDiv = document.getElementById('addressDiv')
            const submitPreviewPhotoButton = document.getElementById('submitPreviewPhoto');
            const submitPostcardButton = document.getElementById('submitPostcard')
            const recipientSelector = document.getElementById('recipientSelector')
            const submitPreviewStatusLabel = document.getElementById('submitPreviewStatusLabel')
            const submitPostcardStatusLabel = document.getElementById('submitPostcardStatusLabel')
            const backTextArea = document.getElementById("backTextArea")
            const postcardslist = document.getElementById("postcardslist")

            fetch("/addresses").then(response =>
                response.json()
            ).then(data => {
                document.getElementById("name").innerText = data["name"]
                document.getElementById("address1").innerText = data["address_line1"]
                document.getElementById("address2").innerText = data["address_line2"]
                document.getElementById("city").innerText = data["address_city"]
                document.getElementById("state").innerText = data["address_state"]
                document.getElementById("zip").innerText = data["address_zip"]
            })

            fetch("/contacts").then(response =>
                response.json()
            ).then(data => {
                contacts = data["contacts"]
                contacts.forEach(contact => {
                    var opt = document.createElement('option')
                    opt.value = contact["recurseId"]
                    opt.innerHTML = contact["name"] + " (" + contact["email"] + ")"
                    recipientSelector.appendChild(opt)
                });
            })

            fetch("/postcards").then(response => response.json()
            ).then(data => {
                console.log(data)
                postcards = data["data"]
                for (let postcard of postcards) {
                    var postcardListItem = document.createElement('li')
                    var postcardURL = document.createElement('a')
                    postcardURL.href = postcard["url"]
                    postcardURL.target = "_blank"
                    postcardURL.innerText = "FROM" + postcard["metadata"]["from_rc_id"]
                    postcardListItem.appendChild(postcardURL)
                    postcardslist.appendChild(postcardListItem)
                }
            })

            addressButton.addEventListener('click', function () {
                if (addressDiv.style.display === "none") {
                    addressButton.innerText = "Hide my address üëª"
                    addressDiv.style.display = "block";
                } else {
                    addressButton.innerText = "Show my address :)"
                    addressDiv.style.display = "none";
                }
            })

            submitPreviewPhotoButton.addEventListener('click', function () {
                let photo = document.getElementById("postcardFileInput").files[0]
                if (!photo) {
                    submitPreviewStatusLabel.innerText = "no photo selected"
                    submitPreviewStatusLabel.style = "background-color: red"
                    return;
                }
                let formData = new FormData()
                formData.append("front-postcard-file", photo)
                formData.append("back", backTextArea.value)
                fetch("/postcards?isPreview=true&toRecurseId=0", { method: "POST", body: formData }).then(response =>
                    response.json()
                ).then(data => {
                    if (!data["err"] && !data["status_code"]) {
                        pdfPreviewLink = document.getElementById("pdfPreviewLink")
                        pdfPreviewLink.innerText = data['url']
                        pdfPreviewLink.href = data['url']
                        submitPreviewStatusLabel.style = ""
                        submitPreviewStatusLabel.innerText = ""
                    } else {
                        submitPreviewStatusLabel.innerText = data["message"]
                        submitPreviewStatusLabel.style = "background-color: red"
                    }
                })
            });

            submitPostcardButton.addEventListener('click', function () {
                let photo = document.getElementById("postcardFileInput").files[0]
                let recipientId = recipientSelector.value
                let receipientName = recipientSelector.options[recipientSelector.selectedIndex].innerText
                if (!photo) {
                    submitPostcardStatusLabel.innerText = "no photo selected"
                    submitPostcardStatusLabel.style = "background-color: red"
                    return
                }
                if (!recipientId) {
                    submitPostcardStatusLabel.innerText = "no recipient selected"
                    return
                }

                let formData = new FormData()
                formData.append("front-postcard-file", photo)
                formData.append("back", backTextArea.value)
                fetch("/postcards?isPreview=false&toRecurseId=" + recipientId, { method: "POST", body: formData }).then(response =>
                    response.json()
                ).then(data => {
                    if (!data["err"] && !data["status_code"]) {
                        submitPostcardStatusLabel.innerText = "success sending to " + receipientName + " ‚úÖ"
                        submitPostcardStatusLabel.style = "background-color: green"
                    } else {
                        submitPostcardStatusLabel.innerText = data["message"]
                        submitPostcardStatusLabel.style = "background-color: red"
                    }
                })
            })

            deleteAddressButton.addEventListener('click', function () {
                fetch("/addresses", { method: "DELETE" }).then(response => {
                    console.log(response)
                    window.location.replace(window.location.href);
                    return;
                });
            })
        }
    </script>
    <style>
        * {
            box-sizing: border-box;
            color: #333333;
            font-family: "Comic Sans MS", "Comic Sans", cursive;
        }

        input {
            display: block;
            font-size: 1.05rem;
            width: 100%;
            padding: 10px;
            border-radius: .25rem;
            border: solid 1px #8c8c8c;
            margin: 0;
        }

        label {
            display: block;
            font-size: 1.1rem;
            margin: 20px 0 5px 0;
        }

        button {
            background-color: #0594d8;
            color: #ffffff;
            border-color: #ffffff;
            font-size: 1.1rem;
            margin-top: 10px;
            width: 100px;
        }

        textarea {
            width: 800px;
            height: 400px;
        }
    </style>
</head>

<body>
    <button id="addressButton">Show my address :)</button>
    <div style="display: none;" id="addressDiv">
        <div id="name"></div>
        <div id="address1"></div>
        <div id="address2"></div>
        <div id="city"></div>
        <div id="state"></div>
        <div id="zip"></div>
        <button id="deleteAddressButton">Delete my address üò¢</button>
    </div>
    <button id="addressButton">Show my postcards :)</button>
    <div id="postcardsDiv">
        <ul id="postcardslist">
        </ul>
    </div>
    <input type="file" id="postcardFileInput" />
    <textarea id="backTextArea">
    </textarea>
    <br>
    <button id="submitPreviewPhoto">Preview</button>
    <div>
        <label id="pdfPreviewLabel">PDF Preview (try refreshing a few times)</label>
        <label id="submitPreviewStatusLabel"></label>
        <a target="_blank" id="pdfPreviewLink" href=""></a>
    </div>
    <div>
        <label>Select who you'd like to send your postcard to. See someone in RC who's not on the list? Tell them to
            sign up at LINK</label>
        <select id="recipientSelector" name="Recipient" id="receipients">
        </select>
        <br><br>
    </div>
    <button id="submitPostcard">Looks good, submit!</button>
    <label id="submitPostcardStatusLabel"></label>

    <div>Made with ‚ù§Ô∏è at the Recurse Center.</div>
</body>

</html>