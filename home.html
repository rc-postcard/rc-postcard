<!DOCTYPE html>
<html lang="en">

<head>
    <title>rc-postcard</title>
    <script type="text/javascript">
        window.onload = function () {
            const addressButton = document.getElementById('addressButton');
            const deleteAddressButton = document.getElementById('deleteAddressButton');
            const addressDiv = document.getElementById('addressDiv')
            const submitPreviewPhotoButton = document.getElementById('submitPreviewPhoto');
            const submitPostcardButton = document.getElementById('submitPostcard')
            const recipientSelector = document.getElementById('recipientSelector')
            const submitPreviewStatusLabel = document.getElementById('submitPreviewStatusLabel')
            const submitPostcardStatusLabel = document.getElementById('submitPostcardStatusLabel')
            const backTextArea = document.getElementById("backTextArea")
            const postcardslist = document.getElementById("postcardslist")
            var contacts;
            var contactMapping = {};

            fetch("/addresses").then(response =>
                response.json()
            ).then(data => {
                document.getElementById("name").innerText = data["name"]
                document.getElementById("address1").innerText = data["address_line1"]
                document.getElementById("address2").innerText = data["address_line2"]
                document.getElementById("city").innerText = data["address_city"]
                document.getElementById("state").innerText = data["address_state"]
                document.getElementById("zip").innerText = data["address_zip"]
            })

            fetch("/contacts").then(response =>
                response.json()
            ).then(data => {
                contacts = data["contacts"]
                contacts.forEach(contact => {
                    var opt = document.createElement('option')
                    opt.value = contact["recurseId"]
                    opt.innerHTML = contact["name"] + " (" + contact["email"] + ")"
                    recipientSelector.appendChild(opt)
                    contactMapping[contact["recurseId"]] = contact["name"];
                });
                return fetch("/postcards");
            }).then(response => response.json()
            ).then(data => {
                postcards = data["data"]
                for (let postcard of postcards) {
                    var postcardListItem = document.createElement('li')
                    
                    var postcardURL = document.createElement('a')
                    postcardURL.href = postcard["url"]
                    postcardURL.target = "_blank"
                    var postcardDiv = document.createElement('div');
                    postcardDiv.classList.add("postcardDiv");

                    var timeDiv = document.createElement('div');
                    var time = new Date(postcard["date_created"]).toLocaleString();
                    timeDiv.innerText = time;

                    var from_id = postcard["metadata"]["from_rc_id"]
                    var from_name = contactMapping[from_id]
                    
                    var senderDiv = document.createElement('div');
                    senderDiv.innerText = from_name;
                    
                    console.log(from_id, from_name, contactMapping);
                    postcardDiv.appendChild(timeDiv)
                    postcardDiv.appendChild(senderDiv)
                    postcardURL.appendChild(postcardDiv)
                    postcardListItem.appendChild(postcardURL)
                    postcardslist.appendChild(postcardListItem)
                }
            });



            addressButton.addEventListener('click', function () {
                if (addressDiv.style.display === "none") {
                    addressButton.innerText = "Hide my address 👻"
                    addressDiv.style.display = "block";
                } else {
                    addressButton.innerText = "Show my address :)"
                    addressDiv.style.display = "none";
                }
            })

            submitPreviewPhotoButton.addEventListener('click', function () {
                let photo = document.getElementById("postcardFileInput").files[0]
                if (!photo) {
                    submitPreviewStatusLabel.innerText = "no photo selected"
                    submitPreviewStatusLabel.style = "background-color: red"
                    return;
                }
                let formData = new FormData()
                formData.append("front-postcard-file", photo)
                formData.append("back", backTextArea.value)
                fetch("/postcards?isPreview=true&toRecurseId=0", { method: "POST", body: formData }).then(response =>
                    response.json()
                ).then(data => {
                    if (!data["err"] && !data["status_code"]) {
                        pdfPreviewLink = document.getElementById("pdfPreviewLink")
                        pdfPreviewLink.innerText = data['url']
                        pdfPreviewLink.href = data['url']
                        submitPreviewStatusLabel.style = ""
                        submitPreviewStatusLabel.innerText = ""
                    } else {
                        submitPreviewStatusLabel.innerText = data["message"]
                        submitPreviewStatusLabel.style = "background-color: red"
                    }
                })
            });

            submitPostcardButton.addEventListener('click', function () {
                let photo = document.getElementById("postcardFileInput").files[0]
                let recipientId = recipientSelector.value
                let receipientName = recipientSelector.options[recipientSelector.selectedIndex].innerText
                if (!photo) {
                    submitPostcardStatusLabel.innerText = "no photo selected"
                    submitPostcardStatusLabel.style = "background-color: red"
                    return
                }
                if (!recipientId) {
                    submitPostcardStatusLabel.innerText = "no recipient selected"
                    return
                }

                let formData = new FormData()
                formData.append("front-postcard-file", photo)
                formData.append("back", backTextArea.value)
                fetch("/postcards?isPreview=false&toRecurseId=" + recipientId, { method: "POST", body: formData }).then(response =>
                    response.json()
                ).then(data => {
                    if (!data["err"] && !data["status_code"]) {
                        submitPostcardStatusLabel.innerText = "success sending to " + receipientName + " ✅"
                        submitPostcardStatusLabel.style = "background-color: green"
                    } else {
                        submitPostcardStatusLabel.innerText = data["message"]
                        submitPostcardStatusLabel.style = "background-color: red"
                    }
                })
            })

            deleteAddressButton.addEventListener('click', function () {
                fetch("/addresses", { method: "DELETE" }).then(response => {
                    console.log(response)
                    window.location.replace(window.location.href);
                    return;
                });
            })

            photoUploadButton = document.getElementById("postcardFileInput");
            photoUploadButton.addEventListener('change', async (e) => {
                let photo = document.getElementById("postcardFileInput").files[0]
                if (!photo) {
                    submitPreviewStatusLabel.innerText = "no photo selected"
                    submitPreviewStatusLabel.style = "background-color: red"
                    return;
                }

                const dataUri = await dataUriFromFormField(photo);
                const imgEl = document.createElement('img');
                imgEl.addEventListener('load', () => {
                    const resizedDataUri = resizeImage(imgEl, imgEl.width);
                    document.querySelector('#img-preview').src = resizedDataUri;
                });
                imgEl.src = dataUri;
            });

            function dataUriFromFormField (field) {
                return new Promise((resolve) => {
                    const reader = new FileReader();
                    reader.addEventListener('load', () => {
                        resolve(reader.result);
                    });
                    reader.readAsDataURL(field);
                });
            }

            function resizeImage (imgEl, wantedWidth) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                // goal (width x height): 6.25 x 4.25
                const aspect = imgEl.width / imgEl.height;

                console.log(aspect);
                canvas.width = wantedWidth;
                canvas.height = wantedWidth * 4.25 / 6.25;

                ctx.drawImage(imgEl, 0, 0, canvas.width, canvas.height);
                return canvas.toDataURL();
            }
        }
    </script>
    <style>
        * {
            box-sizing: border-box;
            color: #333333;
            font-family: "Comic Sans MS", "Comic Sans", cursive;
        }

        input {
            display: block;
            font-size: 1.05rem;
            width: 100%;
            padding: 10px;
            border-radius: .25rem;
            border: solid 1px #8c8c8c;
            margin: 0;
        }

        label {
            display: block;
            font-size: 1.1rem;
            margin: 20px 0 5px 0;
        }

        button {
            background-color: #0594d8;
            color: #ffffff;
            border-color: #ffffff;
            font-size: 1.1rem;
            margin-top: 10px;
            width: 100px;
        }

        textarea {
            width: 800px;
            height: 400px;
        }

        .postcardslist li {
            list-style: none;
            border: 1px solid grey;
            background-color: lightblue;
        }
        
        .postcardslist li:nth-child(2n + 1) {
            background-color: lavender;
        }

        .postcardslist li:not(:last-child) {
            border-bottom: unset;
        }

        .postcardDiv {
            display: grid;
            grid-template-columns: auto 1fr;
            grid-gap: 4rem;
            padding: 0.5rem 1rem;
        }
    </style>
</head>

<body>
    <button id="addressButton">Show my address :)</button>
    <div style="display: none;" id="addressDiv">
        <div id="name"></div>
        <div id="address1"></div>
        <div id="address2"></div>
        <div id="city"></div>
        <div id="state"></div>
        <div id="zip"></div>
        <button id="deleteAddressButton">Delete my address 😢</button>
    </div>
    <button id="addressButton">Show my postcards :)</button>
    <div id="postcardsDiv">
        <ul id="postcardslist" class="postcardslist">
        </ul>
    </div>
    <input type="file" id="postcardFileInput" />
    <img id="img-preview" style="width: 300px;">
    <textarea id="backTextArea">
    </textarea>
    <br>
    <button id="submitPreviewPhoto">Preview</button>
    <div>
        <label id="pdfPreviewLabel">PDF Preview (try refreshing a few times)</label>
        <label id="submitPreviewStatusLabel"></label>
        <a target="_blank" id="pdfPreviewLink" href=""></a>
    </div>
    <div>
        <label>Select who you'd like to send your postcard to. See someone in RC who's not on the list? Tell them to
            sign up at LINK</label>
        <select id="recipientSelector" name="Recipient" id="receipients">
        </select>
        <br><br>
    </div>
    <button id="submitPostcard">Looks good, submit!</button>
    <label id="submitPostcardStatusLabel"></label>

    <div>Made with ❤️ at the Recurse Center.</div>
</body>

</html>
